<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Proxy Order System</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
  <style>
    .tab-button.active {
      border-color: #3B82F6; /* blue-500 */
      color: #2563EB; /* blue-600 */
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <h1 class="text-2xl font-bold text-gray-900">Proxy Order Form</h1>
        <div id="welcomeMessage" class="hidden ml-4 pl-4 border-l border-gray-300 text-gray-600">
          Welcome back, <span id="userEmail" class="font-medium"></span>
        </div>
      </div>
      <div class="relative">
        <button 
          onclick="toggleMenu()"
          class="p-2 rounded-md hover:bg-gray-100"
          aria-label="Toggle menu"
        >
          <i class="fas fa-bars text-gray-600"></i>
        </button>
        <div id="menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
          <a href="/" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
            <i class="fas fa-home mr-2"></i>Home
          </a>
          <button 
            onclick="handleMyOrders()"
            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
          >
            <i class="fas fa-list mr-2"></i>My Orders
          </button>
          <a href="/admin.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" id="adminLink" style="display: none;">
            <i class="fas fa-user-shield mr-2"></i>Admin
          </a>
          <div class="border-t border-gray-100"></div>
          <div id="authButtons">
            <a href="/login.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
              <i class="fas fa-sign-in-alt mr-2"></i>Sign In
            </a>
          </div>
          <button
            onclick="handleLogout()"
            class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100"
            id="logoutButton"
            style="display: none;"
          >
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-4 py-8">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900">Proxy Order Admin</h1>
      <p class="text-gray-600">Manage orders, pricing, and settings</p>
    </header>

    <!-- Navigation Tabs -->
    <div class="flex space-x-4 mb-6">
      <button onclick="showTab('orders')" class="tab-button px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 active:border-blue-500 active:text-blue-600">
        <i class="fas fa-shopping-cart mr-2"></i>Orders
      </button>
      <button onclick="showTab('pricing')" class="tab-button px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 active:border-blue-500 active:text-blue-600">
        <i class="fas fa-tags mr-2"></i>Pricing
      </button>
      <button onclick="showTab('bookkeeping')" class="tab-button px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 active:border-blue-500 active:text-blue-600">
        <i class="fas fa-book mr-2"></i>Bookkeeping
      </button>
      <button onclick="showTab('users')" class="tab-button px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 active:border-blue-500 active:text-blue-600">
        <i class="fas fa-users mr-2"></i>Users
      </button>
    </div>

    <!-- Tab Content -->
    <div id="tab-content">
      <!-- Orders Tab -->
      <div id="orders" class="tab-content">
        <!-- Order Filters -->
        <div class="mb-6 flex items-center gap-4">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Status</label>
            <select id="orderStatusFilter" onchange="filterOrders()" class="w-full p-2 border rounded">
              <option value="all">All Orders</option>
              <option value="Not Started">Not Started</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
          <div class="flex items-end">
            <button onclick="clearFilters()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
              Clear Filters
            </button>
          </div>
        </div>

        <div id="orders-list" class="space-y-4">
          <!-- Orders will be populated here -->
        </div>
      </div>

      <!-- Pricing Tab -->
      <div id="pricing" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-bold mb-4">Pricing Configuration</h2>
          
          <!-- Base Price -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Base Price per Card</label>
            <div class="flex items-center">
              <span class="mr-2">$</span>
              <input type="number" step="0.01" min="0" value="0.50" class="p-2 border rounded w-32" id="base-price">
            </div>
          </div>

          <!-- Volume Discounts -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4">Volume Discounts</h3>
            <div id="discount-tiers" class="space-y-4">
              <!-- Discount tiers will be populated here -->
            </div>
            <button onclick="addDiscountTier()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
              Add Discount Tier
            </button>
          </div>

          <!-- Shipping Options -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4">Shipping Options</h3>
            <div class="space-y-4">
              <div class="flex items-center justify-between p-4 border rounded">
                <div>
                  <h4 class="font-medium">Local Pickup</h4>
                  <p class="text-sm text-gray-500">Free pickup option</p>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" checked class="mr-2" id="local-pickup-enabled">
                  <span class="text-gray-500">Free</span>
                </div>
              </div>
              <div class="flex items-center justify-between p-4 border rounded">
            <div>
                  <h4 class="font-medium">Shipping</h4>
                  <p class="text-sm text-gray-500">Standard shipping option</p>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" checked class="mr-2" id="shipping-enabled">
                  <span class="mr-2">$</span>
                  <input type="number" step="0.01" min="0" value="5.00" class="p-2 border rounded w-24" id="shipping-price">
                </div>
              </div>
            </div>
          </div>

          <div class="flex justify-end">
            <button onclick="savePricing()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
              Save Changes
            </button>
          </div>
        </div>
      </div>

      <!-- Bookkeeping Tab -->
      <div id="bookkeeping" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-bold mb-4">Bookkeeping</h2>
          
          <!-- Date Range Filter -->
          <div class="mb-6 flex gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
              <input type="date" class="p-2 border rounded" id="start-date">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
              <input type="date" class="p-2 border rounded" id="end-date">
                </div>
            <div class="flex items-end">
              <button onclick="filterBookkeeping()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Filter
              </button>
            </div>
          </div>

          <!-- Summary -->
          <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-50 p-4 rounded">
              <h3 class="text-sm font-medium text-gray-500">Total Orders</h3>
              <p class="text-2xl font-bold" id="total-orders">0</p>
            </div>
            <div class="bg-gray-50 p-4 rounded">
              <h3 class="text-sm font-medium text-gray-500">Total Revenue</h3>
              <p class="text-2xl font-bold" id="total-revenue">$0.00</p>
            </div>
            <div class="bg-gray-50 p-4 rounded">
              <h3 class="text-sm font-medium text-gray-500">Average Order Value</h3>
              <p class="text-2xl font-bold" id="avg-order-value">$0.00</p>
          </div>
        </div>

          <!-- Order History -->
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead>
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                </tr>
              </thead>
              <tbody id="bookkeeping-table" class="bg-white divide-y divide-gray-200">
                <!-- Bookkeeping data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-bold mb-4">User Management</h2>
          <div id="users-list" class="space-y-4">
            <!-- Users will be populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Menu toggle function
    function toggleMenu() {
      const menu = document.getElementById('menu');
      menu.classList.toggle('hidden');
    }

    // Handle My Orders click
    function handleMyOrders() {
      if (localStorage.getItem('currentUser')) {
        window.location.href = '/order-history.html';
      } else {
        alert('You need to be logged in to view your orders.');
        window.location.href = '/login.html';
      }
    }

    // Handle logout
    function handleLogout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('isAdmin');
      window.location.href = '/';
    }

    // Auth check (run on every page load)
    document.addEventListener('DOMContentLoaded', () => {
      const currentUserEmail = localStorage.getItem('currentUser'); // Get directly as string
      const isAdmin = localStorage.getItem('isAdmin') === 'true';
      const welcomeMessage = document.getElementById('welcomeMessage');
      const userEmailSpan = document.getElementById('userEmail');
      const authButtons = document.getElementById('authButtons');
      const logoutButton = document.getElementById('logoutButton');
      const adminLink = document.getElementById('adminLink');

      if (currentUserEmail) {
        welcomeMessage.classList.remove('hidden');
        userEmailSpan.textContent = currentUserEmail; // Use directly
        authButtons.style.display = 'none';
        logoutButton.style.display = 'block';
      } else {
        welcomeMessage.classList.add('hidden');
        authButtons.style.display = 'block';
        logoutButton.style.display = 'none';
      }

      if (isAdmin) {
        if (adminLink) adminLink.style.display = 'block';
      } else {
        if (adminLink) adminLink.style.display = 'none';
      }
    });

    // Helper to get status color
    function getStatusColor(status) {
      switch (status) {
        case 'Completed':
          return 'bg-green-100 text-green-800';
        case 'In Progress':
          return 'bg-blue-100 text-blue-800';
        case 'Not Started':
          return 'bg-yellow-100 text-yellow-800';
        case 'Archived':
          return 'bg-gray-100 text-gray-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }

    function updateOrderStatus(orderId, newStatus) {
      // Update in both storage locations
      const updateOrders = (orders) => {
        return orders.map(order => {
          if (order.id === orderId) {
            return { ...order, status: newStatus };
          }
          return order;
        });
      };

      const localOrders = JSON.parse(localStorage.getItem('adminOrders') || '[]');
      const crossBrowserOrders = JSON.parse(localStorage.getItem('crossBrowserOrders') || '[]');

      const updatedLocalOrders = updateOrders(localOrders);
      const updatedCrossBrowserOrders = updateOrders(crossBrowserOrders);

      localStorage.setItem('adminOrders', JSON.stringify(updatedLocalOrders));
      localStorage.setItem('crossBrowserOrders', JSON.stringify(updatedCrossBrowserOrders));

      loadOrders(); // Refresh the orders list
    }

    function archiveOrder(orderId) {
      if (confirm('Are you sure you want to archive this order?')) {
        updateOrderStatus(orderId, 'Archived');
      }
    }

    function deleteOrder(orderId) {
      if (confirm('Are you sure you want to delete this order?')) {
        // Delete from both storage locations
        const localOrders = JSON.parse(localStorage.getItem('adminOrders') || '[]');
        const crossBrowserOrders = JSON.parse(localStorage.getItem('crossBrowserOrders') || '[]');
        
        const filterOrders = (orders) => orders.filter(order => order.id !== orderId);

        const updatedLocalOrders = filterOrders(localOrders);
        const updatedCrossBrowserOrders = filterOrders(crossBrowserOrders);

        localStorage.setItem('adminOrders', JSON.stringify(updatedLocalOrders));
        localStorage.setItem('crossBrowserOrders', JSON.stringify(updatedCrossBrowserOrders));
        
        loadOrders(); // Refresh the orders list
      }
    }

    function loadOrders() {
      const ordersList = document.getElementById('orders-list');
      if (!ordersList) return;

      // Get orders from both storage locations
      const localOrders = JSON.parse(localStorage.getItem('adminOrders') || '[]');
      const crossBrowserOrders = JSON.parse(localStorage.getItem('crossBrowserOrders') || '[]');
      
      // Combine and deduplicate orders
      const allOrders = [...localOrders];
      crossBrowserOrders.forEach(order => {
        if (!allOrders.some(existing => existing.id === order.id)) {
          allOrders.push(order);
        }
      });

      // Sort orders by timestamp (newest first)
      allOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Apply status filter
      const statusFilter = document.getElementById('orderStatusFilter')?.value || 'all';
      const filteredOrders = statusFilter === 'all' 
        ? allOrders 
        : allOrders.filter(order => order.status === statusFilter);

      if (filteredOrders.length === 0) {
        ordersList.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <p>No orders found.</p>
          </div>
        `;
        return;
      }

      ordersList.innerHTML = filteredOrders.map(order => {
        // Calculate total cards
        let totalCards = 0;
        if (typeof order.cards === 'string') {
          const cardLines = order.cards.split('\n').filter(line => line.trim() !== ''); // Filter out empty lines
          totalCards = cardLines.reduce((sum, line) => {
            const parts = line.split('|');
            if (parts.length >= 2) {
              const quantity = parseInt(parts[1].trim()) || 0;
              return sum + quantity;
            }
            return sum;
          }, 0);
        } else if (Array.isArray(order.cards)) {
          totalCards = order.cards.reduce((sum, card) => {
            const quantity = parseInt(card.quantity) || 0;
            return sum + quantity;
          }, 0);
        }

        return `
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-lg font-semibold">Order #${order.id}</h3>
                <p class="text-sm text-gray-500">${new Date(order.timestamp).toLocaleString()}</p>
                <p class="text-sm text-gray-500">User: ${order.userId}</p>
                <p class="text-sm text-gray-500">Browser: ${order.browserId ? order.browserId.substring(0, 30) + '...' : 'Unknown'}</p>
              </div>
              <div class="flex items-center gap-2">
                <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(order.status)}">
                  ${order.status}
                </span>
                <select 
                  onchange="updateOrderStatus('${order.id}', this.value)"
                  class="p-2 border rounded"
                >
                  <option value="Not Started" ${order.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                  <option value="In Progress" ${order.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                  <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
              </div>
            </div>
            <div class="border-t pt-4">
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <p class="text-sm font-medium text-gray-500">Number of Cards</p>
                  <p class="text-lg">${totalCards}</p>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-500">Shipping Method</p>
                  <p class="text-lg">${order.shipping === 'ship' ? 'Ship' : 'Local Pickup'}</p>
                </div>
              </div>
              <div class="flex justify-end gap-2">
                <button 
                  onclick="viewOrderDetails('${order.id}')"
                  class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                >
                  View Details
                </button>
                ${order.status !== 'Archived' ? `
                  <button 
                    onclick="archiveOrder('${order.id}')"
                    class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600"
                  >
                    Archive
                  </button>
                ` : ''}
                <button 
                  onclick="deleteOrder('${order.id}')"
                  class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterOrders() {
      loadOrders(); // Reload orders with the current filter
    }

    function clearFilters() {
      document.getElementById('orderStatusFilter').value = 'all';
      loadOrders(); // Reload all orders
    }

    // Modal functions
    function closeModal() {
      const modal = document.getElementById('orderModal');
      if (modal) {
        modal.remove();
      }
    }

    function viewOrderDetails(orderId) {
      // Get order from either storage location
      const localOrders = JSON.parse(localStorage.getItem('adminOrders') || '[]');
      const crossBrowserOrders = JSON.parse(localStorage.getItem('crossBrowserOrders') || '[]');
      
      const order = localOrders.find(o => o.id === orderId) || 
                   crossBrowserOrders.find(o => o.id === orderId);

      if (!order) {
        alert('Order not found');
        return;
      }

      // Parse cards data
      const cards = typeof order.cards === 'string' 
        ? order.cards.split('\n').filter(line => line.trim() !== '').map(line => {
            const [name, quantity, cardBack] = line.split('|').map(s => s.trim());
            return { name, quantity, cardBack };
          })
        : order.cards;

      // Create modal content
      const modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
              <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold">Order Details #${order.id}</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <div class="grid grid-cols-2 gap-6 mb-6">
                <div>
                  <p class="text-sm font-medium text-gray-500">Order Date</p>
                  <p class="text-lg">${new Date(order.timestamp).toLocaleString()}</p>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-500">User</p>
                  <p class="text-lg">${order.userId}</p>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-500">Status</p>
                  <p class="text-lg">
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(order.status)}">
                      ${order.status}
                    </span>
                  </p>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-500">Shipping Method</p>
                  <p class="text-lg">${order.shipping === 'ship' ? 'Ship' : 'Local Pickup'}</p>
                </div>
              </div>

              <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-semibold">Cards</h3>
                  <button 
                    onclick="copyCardList('${orderId}')"
                    class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                  >
                    Copy List
                  </button>
                </div>
                <div class="space-y-1">
                  ${cards.map(card => `
                    <div class="flex items-center gap-4 p-1 hover:bg-gray-50 rounded">
                      <div class="flex-1 text-sm">
                        <span class="font-medium">${card.name}</span>
                      </div>
                      <div class="flex items-center gap-2">
                        ${card.cardBack && card.cardBack !== 'Default' ? `
                          <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500">Back:</span>
                            <img src="card_backs/${card.cardBack}.jpg" alt="${card.cardBack}" class="w-10 h-10 object-cover rounded shadow">
                          </div>
                        ` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="flex justify-end gap-2">
                <button 
                  onclick="closeModal()"
                  class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                >
                  Close
                </button>
                ${order.status !== 'Archived' ? `
                  <button 
                    onclick="archiveOrder('${order.id}'); closeModal();"
                    class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600"
                  >
                    Archive
                  </button>
                ` : ''}
                <button 
                  onclick="deleteOrder('${order.id}'); closeModal();"
                  class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Add modal to page
      const modalContainer = document.createElement('div');
      modalContainer.id = 'orderModal';
      modalContainer.innerHTML = modalContent;
      document.body.appendChild(modalContainer);
    }

    function copyCardList(orderId) {
      // Get order from either storage location
      const localOrders = JSON.parse(localStorage.getItem('adminOrders') || '[]');
      const crossBrowserOrders = JSON.parse(localStorage.getItem('crossBrowserOrders') || '[]');
      
      const order = localOrders.find(o => o.id === orderId) || 
                   crossBrowserOrders.find(o => o.id === orderId);

      if (!order) {
        alert('Order not found');
        return;
      }

      // Parse cards data and filter out empty lines
      const cards = typeof order.cards === 'string' 
        ? order.cards.split('\n').filter(line => line.trim() !== '').map(line => {
            const [name, quantity, cardBack] = line.split('|').map(s => s.trim());
            return { name, quantity, cardBack };
          })
        : order.cards;

      // Format cards for copying
      const cardList = cards.map(card => {
        // Extract card name and set name from the 'name' field
        const nameParts = card.name.match(/(.+?) \((.+?)\)(?: \((.+?)\))?/); // Improved regex for set name and optional collector number
        let cardName = card.name;
        let setName = '';
        let collectorNumber = '';

        if (nameParts) {
          cardName = nameParts[1].trim();
          setName = nameParts[2] ? `(${nameParts[2].trim()})` : '';
          collectorNumber = nameParts[3] ? ` ${nameParts[3].trim()}` : '';
        }

        const quantity = card.quantity && card.quantity !== 'undefined' ? card.quantity : '1'; // Default to 1 if undefined

        return `${quantity} ${cardName}${setName}${collectorNumber}`;
      }).join('\n');

      // Copy to clipboard
      navigator.clipboard.writeText(cardList).then(() => {
        alert('Card list copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy text: ', err);
        alert('Failed to copy card list. Please try again.');
      });
    }

    // Pricing Tab Functions
    function loadPricingConfig() {
      const config = JSON.parse(localStorage.getItem('pricingConfig') || '{}');
      document.getElementById('base-price').value = config.basePrice || 0.50;

      const discountTiersContainer = document.getElementById('discount-tiers');
      discountTiersContainer.innerHTML = ''; // Clear existing tiers

      if (config.volumeDiscounts && config.volumeDiscounts.length > 0) {
        config.volumeDiscounts.sort((a, b) => a.min - b.min).forEach((discount, index) => {
          const tierHtml = `
            <div class="flex items-center gap-4 p-4 border rounded">
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Min Cards</label>
                <input type="number" min="1" class="w-full p-2 border rounded tier-min" value="${discount.min}" data-index="${index}">
              </div>
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Discount (%)</label>
                <input type="number" step="0.01" min="0" max="100" class="w-full p-2 border rounded tier-percent" value="${discount.percent * 100}" data-index="${index}">
              </div>
              <button onclick="removeDiscountTier(this)" class="mt-auto px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Remove</button>
            </div>
          `;
          discountTiersContainer.insertAdjacentHTML('beforeend', tierHtml);
        });
      }

      document.getElementById('local-pickup-enabled').checked = config.shipping?.localPickup?.enabled !== false;
      document.getElementById('shipping-enabled').checked = config.shipping?.shipping?.enabled !== false;
      document.getElementById('shipping-price').value = config.shipping?.shipping?.price || 5.00;
    }

    function addDiscountTier() {
      const discountTiersContainer = document.getElementById('discount-tiers');
      const newIndex = discountTiersContainer.children.length;
      const tierHtml = `
        <div class="flex items-center gap-4 p-4 border rounded">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Min Cards</label>
            <input type="number" min="1" class="w-full p-2 border rounded tier-min" value="" data-index="${newIndex}">
          </div>
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Discount (%)</label>
            <input type="number" step="0.01" min="0" max="100" class="w-full p-2 border rounded tier-percent" value="" data-index="${newIndex}">
          </div>
          <button onclick="removeDiscountTier(this)" class="mt-auto px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Remove</button>
        </div>
      `;
      discountTiersContainer.insertAdjacentHTML('beforeend', tierHtml);
    }

    function removeDiscountTier(button) {
      button.closest('.flex.items-center.gap-4').remove();
    }

    function savePricing() {
      const basePrice = parseFloat(document.getElementById('base-price').value);
      if (isNaN(basePrice) || basePrice <= 0) {
        alert('Please enter a valid base price.');
        return;
      }

      const volumeDiscounts = [];
      document.querySelectorAll('#discount-tiers > div').forEach(tierDiv => {
        const minCardsInput = tierDiv.querySelector('.tier-min');
        const percentInput = tierDiv.querySelector('.tier-percent');

        const min = parseInt(minCardsInput.value);
        const percent = parseFloat(percentInput.value) / 100;

        if (isNaN(min) || min < 1 || isNaN(percent) || percent < 0 || percent > 1) {
          alert('Please enter valid numbers for all discount tiers.');
          return;
        }
        volumeDiscounts.push({ min, percent });
      });

      // Sort discounts by min cards
      volumeDiscounts.sort((a, b) => a.min - b.min);

      const localPickupEnabled = document.getElementById('local-pickup-enabled').checked;
      const shippingEnabled = document.getElementById('shipping-enabled').checked;
      const shippingPrice = parseFloat(document.getElementById('shipping-price').value);

      if (shippingEnabled && (isNaN(shippingPrice) || shippingPrice < 0)) {
        alert('Please enter a valid shipping price.');
        return;
      }

      const pricingConfig = {
        basePrice,
        volumeDiscounts,
        shipping: {
          localPickup: { enabled: localPickupEnabled },
          shipping: { enabled: shippingEnabled, price: shippingPrice }
        }
      };

      localStorage.setItem('pricingConfig', JSON.stringify(pricingConfig));
      alert('Pricing configuration saved!');
      loadPricingConfig(); // Reload to reflect changes
    }

    // Bookkeeping Tab Functions
    function loadBookkeeping() {
      const allOrders = JSON.parse(localStorage.getItem('adminOrders') || '[]')
                          .concat(JSON.parse(localStorage.getItem('crossBrowserOrders') || '[]'))
                          .filter((order, index, self) => 
                            index === self.findIndex((o) => o.id === order.id)
                          ); // Deduplicate

      // Apply date range filter
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;

      const filteredOrders = allOrders.filter(order => {
        const orderDate = new Date(order.timestamp);
        if (startDate && orderDate < new Date(startDate)) return false;
        if (endDate && orderDate > new Date(endDate + 'T23:59:59')) return false; // End of day
        return true;
      });

      document.getElementById('total-orders').textContent = filteredOrders.length;

      let totalRevenue = 0;
      filteredOrders.forEach(order => {
        totalRevenue += calculateOrderTotal(order);
      });
      document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);

      document.getElementById('avg-order-value').textContent = filteredOrders.length > 0
        ? formatCurrency(totalRevenue / filteredOrders.length)
        : formatCurrency(0);

      const bookkeepingTableBody = document.getElementById('bookkeeping-table');
      bookkeepingTableBody.innerHTML = '';

      if (filteredOrders.length === 0) {
        bookkeepingTableBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-gray-500">No orders found for this period.</td>
          </tr>
        `;
        return;
      }

      filteredOrders.forEach(order => {
        const row = `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">${new Date(order.timestamp).toLocaleDateString()}</td>
            <td class="px-6 py-4 whitespace-nowrap">${order.id}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              ${typeof order.cards === 'string' ? order.cards.split('\n').filter(line => line.trim() !== '').length : order.cards.length} items
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(calculateOrderTotal(order))}</td>
          </tr>
        `;
        bookkeepingTableBody.insertAdjacentHTML('beforeend', row);
      });
    }

    function filterBookkeeping() {
      loadBookkeeping();
    }

    // Function to format currency (re-used from order-view.html)
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount);
    }

    // Function to calculate order total (re-used from order-view.html)
    function calculateOrderTotal(order) {
      const config = JSON.parse(localStorage.getItem('pricingConfig') || '{}');
      const basePrice = config.basePrice || 0.50;

      let cardCount = 0;
      if (typeof order.cards === 'string') {
        cardCount = order.cards.split('\n').filter(line => line.trim() !== '').length;
      } else if (Array.isArray(order.cards)) {
        cardCount = order.cards.reduce((sum, card) => sum + (parseInt(card.quantity) || 0), 0);
      }
      
      const cardsInTier = Math.floor(cardCount / 8) * 8;
      const extraCards = cardCount % 8;
      
      const tierPrice = basePrice * (1 - (config.volumeDiscounts?.find(d => d.min <= cardsInTier)?.percent || 0));
      const extraPrice = extraCards * basePrice;
      
      const subtotal = (cardsInTier * tierPrice) + extraPrice;
      const shippingCost = order.shipping === 'ship' ? (config.shipping?.shipping?.price || 5.00) : 0;
      
      return subtotal + shippingCost;
    }

    // Tab Functions
    function showTab(tabId) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      // Remove active state from all tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      
      // Show selected tab content
      const selectedTab = document.getElementById(tabId);
      if (selectedTab) {
        selectedTab.classList.remove('hidden');
      }
      
      // Add active state to selected tab button
      const selectedButton = document.querySelector(`[onclick="showTab('${tabId}')"]`);
      if (selectedButton) {
        selectedButton.classList.add('active');
      }

      // Load specific data based on tab
      switch(tabId) {
        case 'orders':
          loadOrders();
          break;
        case 'pricing':
          loadPricingConfig();
          break;
        case 'bookkeeping':
          loadBookkeeping();
          break;
        case 'users':
          loadUsers();
          break;
      }
    }

    // Users Tab Functions
    function loadUsers() {
      const usersList = document.getElementById('users-list');
      if (!usersList) {
        console.error('Users list element not found');
        return;
      }

      // Get users from both storage locations
      const localUsers = JSON.parse(localStorage.getItem('users') || '[]');
      const crossBrowserUsers = JSON.parse(localStorage.getItem('crossBrowserUsers') || '[]');
      
      // Combine and deduplicate users
      const allUsers = [...localUsers];
      crossBrowserUsers.forEach(user => {
        if (!allUsers.some(existing => existing.email === user.email)) {
          allUsers.push(user);
        }
      });

      // Sort users: admins first, then alphabetically by email
      allUsers.sort((a, b) => {
        if (a.isAdmin && !b.isAdmin) return -1;
        if (!a.isAdmin && b.isAdmin) return 1;
        return a.email.localeCompare(b.email);
      });

      if (allUsers.length === 0) {
        usersList.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <p>No users found.</p>
          </div>
        `;
        return;
      }

      usersList.innerHTML = allUsers.map(user => `
        <div class="bg-white rounded-lg shadow p-6 mb-4">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-lg font-semibold flex items-center gap-2">
                ${user.email}
                ${user.isAdmin ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Admin</span>' : ''}
              </h3>
              <p class="text-sm text-gray-500">Browser: ${user.browserId ? user.browserId.substring(0, 30) + '...' : 'Unknown'}</p>
            </div>
            <div class="flex gap-2">
              ${user.email !== 'dphillips83@gmail.com' ? `
                <button 
                  onclick="toggleAdminStatus('${user.email}')"
                  class="px-4 py-2 rounded ${user.isAdmin ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-500 hover:bg-blue-600'} text-white"
                >
                  ${user.isAdmin ? 'Remove Admin' : 'Make Admin'}
                </button>
                <button 
                  onclick="deleteUser('${user.email}')"
                  class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                >
                  Delete
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function toggleAdminStatus(email) {
      // Update admin status in both storage locations
      const localUsers = JSON.parse(localStorage.getItem('users') || '[]');
      const crossBrowserUsers = JSON.parse(localStorage.getItem('crossBrowserUsers') || '[]');
      
      const updateUsers = (users) => {
        return users.map(user => {
          if (user.email === email) {
            return { ...user, isAdmin: !user.isAdmin };
          }
          return user;
        });
      };

      const updatedLocalUsers = updateUsers(localUsers);
      const updatedCrossBrowserUsers = updateUsers(crossBrowserUsers);

      localStorage.setItem('users', JSON.stringify(updatedLocalUsers));
      localStorage.setItem('crossBrowserUsers', JSON.stringify(updatedCrossBrowserUsers));
      
      loadUsers(); // Refresh the users list
    }

    function deleteUser(email) {
      if (confirm(`Are you sure you want to delete user ${email}?`)) {
        // Delete user from both storage locations
        const localUsers = JSON.parse(localStorage.getItem('users') || '[]');
        const crossBrowserUsers = JSON.parse(localStorage.getItem('crossBrowserUsers') || '[]');
        
        const filterUsers = (users) => users.filter(user => user.email !== email);

        const updatedLocalUsers = filterUsers(localUsers);
        const updatedCrossBrowserUsers = filterUsers(crossBrowserUsers);

        localStorage.setItem('users', JSON.stringify(updatedLocalUsers));
        localStorage.setItem('crossBrowserUsers', JSON.stringify(updatedCrossBrowserUsers));
        
        loadUsers(); // Refresh the users list
      }
    }

    // Initialize the first tab
    document.addEventListener('DOMContentLoaded', () => {
      showTab('orders');
    });
  </script>
</body>
</html>